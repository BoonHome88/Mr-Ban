<script>
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1390666314716287007/gjFpxeI2T5Tx6odcZBSkftTLxhEtt8kCDIOTn1l35sOE09Kghp6ZtqxcktTNz4qAeGqB";
const BACKEND_URL = "https://mr-ban-production.up.railway.app";

const form = document.getElementById('banForm');
const previewBtn = document.getElementById('previewBtn');
const previewBox = document.getElementById('previewBox');
const embedPreview = document.getElementById('embedPreview');

const colorMap = {
    "‡∏ñ‡∏≤‡∏ß‡∏£": { emoji: "üî¥", hex: 0xFF0000, color: "red" },
    "‡πÉ‡∏ö‡πÅ‡∏î‡∏á": { emoji: "üî¥", hex: 0xFF0000, color: "red" },
    "‡πÉ‡∏ö‡∏™‡πâ‡∏°": { emoji: "üü†", hex: 0xFFA500, color: "orange" },
    "‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á": { emoji: "üü°", hex: 0xFFFF00, color: "yellow" },
    "‡∏õ‡∏£‡∏±‡∏ö": { emoji: "üí∏", hex: 0x00FF00, color: "green" }
};

async function getDiscordAvatar(discordId) {
    try {
        const res = await fetch(`${BACKEND_URL}/${discordId}`);
        const data = await res.json();
        return data.avatar;
    } catch {
        return `https://cdn.discordapp.com/embed/avatars/${discordId % 5}.png`;
    }
}

async function updatePreview() {
    const name = document.getElementById('name').value;
    const discord = document.getElementById('discord').value;
    const steam = document.getElementById('steamhex').value;
    const reason = document.getElementById('reason').value;
    const fine = document.getElementById('fine').value;
    const admin = document.getElementById('admin').value;
    const banType = document.getElementById('banType').value;

    const avatarUrl = await getDiscordAvatar(discord);

    embedPreview.innerHTML = `
        <div class="embed-header">
            <img src="${avatarUrl}" class="avatar">
            <h3>${colorMap[banType].emoji} ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ö <span style="color:${colorMap[banType].color}">${banType}</span></h3>
        </div>
        <div class="embed-field">
            <div class="embed-field-value">
                üì¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${banType}<br>
                üë§ ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°: ${name}<br>
                üí¨ Discord ID: ${discord}<br>
                üéÆ Steam Hex: ${steam}<br>
                ‚ö†Ô∏è ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}<br>
                üí∏ ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö: ${fine}<br>
                üëÆ‚Äç‚ôÇÔ∏è ‡∏ú‡∏π‡πâ‡πÅ‡∏ö‡∏ô: ${admin}
            </div>
        </div>
        <div class="embed-footer">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏∑‡πà‡∏≠ | ${new Date().toLocaleString('th-TH')}</div>
    `;
    previewBox.style.display = 'block';
    previewBox.scrollIntoView({ behavior: 'smooth' });
}

previewBtn.addEventListener('click', updatePreview);

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await updatePreview();

    const name = document.getElementById('name').value;
    const discord = document.getElementById('discord').value;
    const steam = document.getElementById('steamhex').value;
    const reason = document.getElementById('reason').value;
    const fine = document.getElementById('fine').value;
    const admin = document.getElementById('admin').value;
    const banType = document.getElementById('banType').value;
    const avatarUrl = await getDiscordAvatar(discord);

    const fieldValue = 
`üì¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${banType}
üë§ ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°: ${name}
üí¨ Discord ID: ${discord}
üéÆ Steam Hex: ${steam}
‚ö†Ô∏è ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}
üí∏ ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö: ${fine}
üëÆ‚Äç‚ôÇÔ∏è ‡∏ú‡∏π‡πâ‡πÅ‡∏ö‡∏ô: ${admin}`;

    const payload = {
        embeds: [{
            title: "üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ô",
            color: colorMap[banType].hex,
            thumbnail: { url: avatarUrl },
            fields: [
                { name: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", value: fieldValue, inline: false }
            ],
            footer: { text: `‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${new Date().toLocaleString('th-TH')}` }
        }]
    };

    try {
        const response = await fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (response.ok) {
            alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Discord ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
            form.reset();
            previewBox.style.display = 'none';
        } else {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    } catch (error) {
        console.error(error);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Discord");
    }
});
</script>
